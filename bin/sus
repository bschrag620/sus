#!/usr/bin/env ruby

require 'etc'
require_relative '../lib/sus'

registry = Sus::Registry.new
jobs = Thread::Queue.new
results = Thread::Queue.new

Result = Struct.new(:job, :assertions)

loader = Thread.new do
	if ARGV.any?
		ARGV.each do |path|
			registry.load(path)
		end
	else
		Dir.glob("test/**/*.rb").each do |path|
			registry.load(path)
		end
	end
	
	registry.each do |child|
		jobs << child
	end
	
	jobs.close
end

output = Sus::Terminal.default

aggregation = Thread.new do
	assertions = Sus::Assertions.new(output: output)
	first = true
	
	while result = results.pop
		if result.assertions.failed?
			if first
				first = false
			else
				assertions.output.print_line
			end
			
			result.assertions.output.append(assertions.output)
		end
		
		assertions.add(result.assertions)
	end
	
	assertions.output.print_line unless first
	assertions.print(output)
end

count = 1 # Etc.nprocessors

workers = count.times.map do
	Thread.new do
		while job = jobs.pop
			assertions = Sus::Assertions.new(output: output.buffered)
			job.call(assertions)
			results << Result.new(job, assertions)
		end
	end
end

loader.join

workers.each(&:join)
results.close

aggregation.join
